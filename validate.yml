---
# validate.yml

- name: Validate the network
  hosts: FABRIC
  gather_facts: false
  tasks:
    - name: Validate the network
      ansible.builtin.import_role:
        name: arista.avd.anta_runner

- name: Phase 2 - Push Reports to GitHub
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    git_repo_url: "github.com/JulioPDX/aap-avd-demo.git"
    git_branch: "anta_results"
    # This is where your reports were generated in Phase 1
    local_report_path: "{{ playbook_dir }}/anta/reports"
    # Temporary location for the git operations
    temp_repo_path: "/tmp/anta_update"
    gh_user: "{{ lookup('env', 'GITHUB_USER') }}"
    gh_token: "{{ lookup('env', 'GITHUB_TOKEN') }}"

  tasks:
    - name: Create temporary directory
      ansible.builtin.file:
        path: "{{ temp_repo_path }}"
        state: absent # Clean up any old runs first

    - name: Clone repo for pushing
      ansible.builtin.shell: >
        git clone https://{{ gh_user | urlencode }}:{{ gh_token | urlencode }}@{{ git_repo_url }} {{ temp_repo_path }}
      no_log: true

    - name: Configure Git identity in temp repo
      ansible.builtin.shell: |
        git config user.name "github-actions[bot]"
        git config user.email "bot@aap.local"
      args:
        chdir: "{{ temp_repo_path }}"

    - name: Checkout or Create target branch
      ansible.builtin.shell: |
        git checkout {{ git_branch }} || git checkout -b {{ git_branch }}
      args:
        chdir: "{{ temp_repo_path }}"

    - name: Copy generated reports to temp repo
      ansible.builtin.copy:
        src: "{{ local_report_path }}/"
        dest: "{{ temp_repo_path }}/anta/reports/"
        remote_src: yes

    - name: Check for changes
      ansible.builtin.shell: "git status --porcelain"
      register: git_status
      args:
        chdir: "{{ temp_repo_path }}"
      changed_when: false

    - name: Commit and Push
      ansible.builtin.shell: |
        git add .
        git commit -m "ANTA Report Update - Job {{ tower_job_id | default('manual') }}"
        git push origin {{ git_branch }}
      args:
        chdir: "{{ temp_repo_path }}"
      when: git_status.stdout != ""
      no_log: true

    - name: Cleanup
      ansible.builtin.file:
        path: "{{ temp_repo_path }}"
        state: absent
